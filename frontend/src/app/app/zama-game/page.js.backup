"use client";
import { useEffect, useState } from "react";
import { ethers } from "ethers";
import { motion, AnimatePresence } from "framer-motion";
import { Button } from "@/components/ui/button";
import { Card, CardContent, CardDescription, CardHeader, CardTitle } from "@/components/ui/card";
import { Tabs, TabsContent, TabsList, TabsTrigger } from "@/components/ui/tabs";
import { Input } from "@/components/ui/input";
import { Label } from "@/components/ui/label";
import { Vote, DollarSign, Trophy, Shield, Clock, TrendingUp, Award, Sparkles, Plus, List, Calendar, CheckCircle, XCircle } from "lucide-react";
import VotingFactoryABI from "./contracts/VotingFactory.sol/VotingFactory.json";
import PrivateVotingABI from "./contracts/zamahub.sol/PrivateVoting.json";
import MockUSDCABI from "./contracts/MockUSDC.sol/MockUSDC.json";


export default function ZamaVotingPage() {
  const [status, setStatus] = useState("Initializing...");
  const [instance, setInstance] = useState(null);
  const [userAddress, setUserAddress] = useState("");
  const [activeTab, setActiveTab] = useState("votings");
  
  // Create voting form state
  const [votingName, setVotingName] = useState("");
  const [voteDeposit, setVoteDeposit] = useState("10");
  const [votingDuration, setVotingDuration] = useState("3600"); // 1 hour in seconds
  const [votingStartTime, setVotingStartTime] = useState("");
  const [createLoading, setCreateLoading] = useState(false);
  
  // Votings list state
  const [allVotings, setAllVotings] = useState([]);
  const [ongoingVotings, setOngoingVotings] = useState([]);
  const [upcomingVotings, setUpcomingVotings] = useState([]);
  const [endedVotings, setEndedVotings] = useState([]);
  const [listLoading, setListLoading] = useState(false);
  
  // Selected voting state
  const [selectedVoting, setSelectedVoting] = useState(null);
  const [votingData, setVotingData] = useState(null);
  const [selectedOption, setSelectedOption] = useState(null);
  const [usdcBalance, setUsdcBalance] = useState("0");
  const [votingLoading, setVotingLoading] = useState(false);

  // Deployed contract addresses
  const votingFactoryAddress = "0x6D6BbdbB4Bb1C2361C45FC2548C20Da7EF822330";
  const usdcContractAddress = "0xffE01B10073099afafE2D09fE4c125E68864587A";
  const wheelPoolAddress = "0xd2F31a7F36f74ae697f790d01B45DBc4a9Ade429";
  const decryptionOracleAddress = "0xa02Cda4Ca3a71D7C46997716F4283aa851C28812";
  const protocolTreasuryAddress = "0xF92c6d8F1cba15eE6c737a7E5c121ad5b6b78982";

  // === Initialize the Zama SDK ===
  useEffect(() => {
    const initZama = async () => {
      try {
        const response = await fetch(
          "https://cdn.zama.ai/relayer-sdk-js/0.2.0/relayer-sdk-js.js"
        );
        const text = await response.text();

        const utf8Bytes = new TextEncoder().encode(text);
        let binary = "";
        const chunkSize = 0x8000;
        for (let i = 0; i < utf8Bytes.length; i += chunkSize) {
          binary += String.fromCharCode.apply(
            null,
            utf8Bytes.subarray(i, i + chunkSize)
          );
        }
        const base64 = btoa(binary);

        const script = document.createElement("script");
        script.type = "module";
        script.textContent = `
          import * as ZamaSDK from 'data:text/javascript;base64,${base64}';
          window.ZamaSDK = ZamaSDK;
          window.dispatchEvent(new Event('zama-ready'));
        `;
        document.head.appendChild(script);

        await new Promise((resolve, reject) => {
          const timeout = setTimeout(
            () => reject(new Error("Zama SDK load timeout")),
            10000
          );
          window.addEventListener("zama-ready", () => {
            clearTimeout(timeout);
            resolve();
          });
        });

        const { initSDK, createInstance, SepoliaConfig } = window.ZamaSDK || {};
        if (!initSDK) throw new Error("Zama SDK not loaded properly");

        await initSDK();

        if (!window.ethereum) throw new Error("MetaMask not detected");
        const accounts = await window.ethereum.request({
          method: "eth_requestAccounts",
        });
        const userAddr = ethers.getAddress(accounts[0]);
        setUserAddress(userAddr);

        const config = { ...SepoliaConfig, network: window.ethereum };
        const instance = await createInstance(config);
        setInstance(instance);

        setStatus("‚úÖ SDK initialized successfully");
      } catch (err) {
        console.error("‚ùå Zama Init Error:", err);
        setStatus(`‚ùå ${err.message}`);
      }
    };

    initZama();
  }, []);

  // === FACTORY FUNCTIONS ===

  // Load all votings from factory
  const loadAllVotings = async () => {
    try {
      setListLoading(true);
      const provider = new ethers.BrowserProvider(window.ethereum);
      const factory = new ethers.Contract(
        votingFactoryAddress,
        VotingFactoryABI.abi,
        provider
      );

      // Get all votings categorized
      const [all, ongoing, upcoming, ended] = await Promise.all([
        factory.getAllVotings(),
        factory.getActiveVotings(),
        factory.getUpcomingVotings(),
        factory.getEndedVotings()
      ]);

      // Load details for each voting
      const loadVotingDetails = async (address) => {
        const voting = new ethers.Contract(address, PrivateVotingABI.abi, provider);
        try {
          const [name, startTime, endTime, depositAmount, resolved, revealed] = await Promise.all([
            voting.name(),
            voting.votingStartTime(),
            voting.votingEndTime(),
            voting.voteDepositAmount(),
            voting.votingResolved(),
            voting.resultsRevealed()
          ]);
          
          return {
            address,
            name,
            startTime: Number(startTime),
            endTime: Number(endTime),
            depositAmount: ethers.formatUnits(depositAmount, 6),
            resolved,
            revealed
          };
        } catch (err) {
          console.error(`Error loading voting ${address}:`, err);
          return null;
        }
      };

      const [allDetails, ongoingDetails, upcomingDetails, endedDetails] = await Promise.all([
        Promise.all(all.map(loadVotingDetails)),
        Promise.all(ongoing.map(loadVotingDetails)),
        Promise.all(upcoming.map(loadVotingDetails)),
        Promise.all(ended.map(loadVotingDetails))
      ]);

      setAllVotings(allDetails.filter(Boolean));
      setOngoingVotings(ongoingDetails.filter(Boolean));
      setUpcomingVotings(upcomingDetails.filter(Boolean));
      setEndedVotings(endedDetails.filter(Boolean));
      
      console.log("‚úÖ Votings loaded:", { all: allDetails.length, ongoing: ongoingDetails.length, upcoming: upcomingDetails.length, ended: endedDetails.length });
    } catch (err) {
      console.error("‚ùå Failed to load votings:", err);
      setStatus(`‚ùå Failed to load votings: ${err.message}`);
    } finally {
      setListLoading(false);
    }
  };

  // Create a new voting
  const handleCreateVoting = async () => {
    try {
      if (!votingName.trim()) {
        throw new Error("Please enter a voting name");
      }
      if (!votingStartTime) {
        throw new Error("Please select a start time");
      }

      setCreateLoading(true);
      setStatus("Creating voting...");

      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const factory = new ethers.Contract(
        votingFactoryAddress,
        VotingFactoryABI.abi,
        signer
      );

      // Convert inputs
      const depositAmount = ethers.parseUnits(voteDeposit, 6);
      const startTimeUnix = Math.floor(new Date(votingStartTime).getTime() / 1000);
      const durationSeconds = Number(votingDuration);

      const tx = await factory.createVoting(
        votingName,
        depositAmount,
        startTimeUnix,
        durationSeconds
      );

      setStatus(`‚è≥ Creating voting: ${tx.hash}`);
      const receipt = await tx.wait();
      
      // Extract the voting address from events
      const event = receipt.logs.find(log => {
        try {
          const parsed = factory.interface.parseLog(log);
          return parsed.name === "VotingCreated";
        } catch {
          return false;
        }
      });

      if (event) {
        const parsed = factory.interface.parseLog(event);
        const newVotingAddress = parsed.args.votingAddress;
        setStatus(`‚úÖ Voting created at: ${newVotingAddress}`);
      } else {
        setStatus("‚úÖ Voting created successfully!");
      }

      // Reset form
      setVotingName("");
      setVotingStartTime("");
      
      // Reload votings list
      await loadAllVotings();
    } catch (err) {
      console.error("‚ùå Create Voting Error:", err);
      setStatus(`‚ùå Failed to create voting: ${err.message || err.reason}`);
    } finally {
      setCreateLoading(false);
    }
  };

  // Load voting data for a specific voting contract
  const loadVotingData = async (votingAddress = selectedVoting) => {
    if (!votingAddress) return;
    try {
      if (!userAddress) return;

      const provider = new ethers.BrowserProvider(window.ethereum);
      const votingContract = new ethers.Contract(
        votingAddress,
        PrivateVotingABI.abi,
        provider
      );
      const usdcContract = new ethers.Contract(
        usdcContractAddress,
        MockUSDCABI.abi,
        provider
      );

      const [
        name,
        votingEndTime,
        totalVotingUSDC,
        hasVoted,
        hasClaimedReward,
        resultsRevealed,
        votingResolved,
        timeRemaining,
        usdcBal,
        voteDecrypted
      ] = await Promise.all([
        votingContract.name(),
        votingContract.votingEndTime(),
        votingContract.totalVotingUSDC(),
        votingContract.hasVoted(userAddress),
        votingContract.hasClaimedReward(userAddress),
        votingContract.resultsRevealed(),
        votingContract.votingResolved(),
        votingContract.timeUntilVotingEnds(),
        usdcContract.balanceOf(userAddress),
        votingContract.voteDecrypted(userAddress)
      ]);

      const data = {
        name,
        votingEndTime: Number(votingEndTime),
        totalVotingUSDC: ethers.formatUnits(totalVotingUSDC, 6),
        hasVoted,
        hasClaimedReward,
        resultsRevealed,
        votingResolved,
        timeRemaining: Number(timeRemaining),
        voteDecrypted
      };

      // Load vote counts and rankings if revealed
      if (resultsRevealed && votingResolved) {
        const [votesA, votesB, votesC, minorityOption, middleOption, majorityOption, minorityMultiplier, middleMultiplier, majorityMultiplier] = await Promise.all([
          votingContract.votesA(),
          votingContract.votesB(),
          votingContract.votesC(),
          votingContract.minorityOption(),
          votingContract.middleOption(),
          votingContract.majorityOption(),
          votingContract.minorityMultiplier(),
          votingContract.middleMultiplier(),
          votingContract.majorityMultiplier()
        ]);
        data.votesA = Number(votesA);
        data.votesB = Number(votesB);
        data.votesC = Number(votesC);
        data.minorityOption = Number(minorityOption);
        data.middleOption = Number(middleOption);
        data.majorityOption = Number(majorityOption);
        data.minorityMultiplier = Number(minorityMultiplier);
        data.middleMultiplier = Number(middleMultiplier);
        data.majorityMultiplier = Number(majorityMultiplier);
      }

      // Load user's decrypted vote if available
      if (voteDecrypted) {
        const decryptedVote = await votingContract.decryptedVotes(userAddress);
        data.userDecryptedVote = Number(decryptedVote);
        
        // Calculate user's reward amount if voting is resolved
        if (resultsRevealed && votingResolved) {
          const netDeposit = 9.8; // 10 USDC - 2% fee = 9.8 USDC
          let multiplier = 0;
          
          if (data.userDecryptedVote === data.minorityOption) {
            multiplier = data.minorityMultiplier;
          } else if (data.userDecryptedVote === data.middleOption) {
            multiplier = data.middleMultiplier;
          } else if (data.userDecryptedVote === data.majorityOption) {
            multiplier = data.majorityMultiplier;
          }
          
          data.userRewardAmount = (netDeposit * multiplier) / 100;
        }
      }

      setVotingData(data);
      setUsdcBalance(ethers.formatUnits(usdcBal, 6));
      console.log("‚úÖ Voting data loaded:", data);
    } catch (err) {
      console.error("‚ùå Failed to load voting data:", err);
    }
  };

  // Mint Mock USDC
  const handleMintUSDC = async () => {
    try {
      setVotingLoading(true);
      setStatus("Minting 1000 USDC...");

      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const usdcContract = new ethers.Contract(
        usdcContractAddress,
        MockUSDCABI.abi,
        signer
      );

      const amount = ethers.parseUnits("1000", 6);
      const tx = await usdcContract.mint(userAddress, amount);
      
      setStatus(`‚è≥ Minting USDC: ${tx.hash}`);
      await tx.wait();

      setStatus("‚úÖ Minted 1000 USDC successfully!");
      await loadVotingData();
    } catch (err) {
      console.error("‚ùå Mint Error:", err);
      setStatus(`‚ùå Mint failed: ${err.message || err.reason}`);
    } finally {
      setVotingLoading(false);
    }
  };

  // Vote with encrypted option
  const handleVote = async () => {
    try {
      if (!instance) throw new Error("SDK not ready");
      if (selectedOption === null) throw new Error("Select an option");

      setVotingLoading(true);
      
      if (parseFloat(usdcBalance) < 10) {
        throw new Error("Insufficient USDC balance. Mint some first!");
      }

      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      
      const usdcContract = new ethers.Contract(
        usdcContractAddress,
        MockUSDCABI.abi,
        signer
      );
      
      if (!selectedVoting) throw new Error("No voting selected");
      
      const allowance = await usdcContract.allowance(userAddress, selectedVoting);
      const requiredAmount = ethers.parseUnits(votingData?.depositAmount || "10", 6);
      
      if (allowance < requiredAmount) {
        setStatus("Approving USDC...");
        const approveTx = await usdcContract.approve(selectedVoting, requiredAmount);
        await approveTx.wait();
      }

      setStatus("Encrypting your vote...");
      const buffer = instance.createEncryptedInput(selectedVoting, userAddress);
      buffer.add8(selectedOption);
      
      const ciphertexts = await buffer.encrypt();

      const votingContract = new ethers.Contract(
        selectedVoting,
        PrivateVotingABI.abi,
        signer
      );

      setStatus("Submitting vote...");
      const tx = await votingContract.depositVote(
        ciphertexts.handles[0],
        ciphertexts.inputProof
      );

      setStatus(`‚è≥ Confirming vote: ${tx.hash}`);
      await tx.wait();

      setStatus("‚úÖ Vote submitted successfully!");
      setSelectedOption(null);
      await loadVotingData();
    } catch (err) {
      console.error("‚ùå Vote Error:", err);
      setStatus(`‚ùå Vote failed: ${err.message || err.reason}`);
    } finally {
      setVotingLoading(false);
    }
  };

  // Request vote decryption - separate step before claiming
  const handleRequestDecryption = async () => {
    try {
      if (!selectedVoting) throw new Error("No voting selected");
      
      setVotingLoading(true);
      setStatus("üîê Requesting vote decryption...");

      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const votingContract = new ethers.Contract(
        selectedVoting,
        PrivateVotingABI.abi,
        signer
      );

      // Call the separate requestUserVoteDecryption function
      const tx = await votingContract.requestUserVoteDecryption();
      setStatus(`‚è≥ Confirming decryption request: ${tx.hash}`);
      await tx.wait();

      setStatus("‚úÖ Decryption requested! Waiting for oracle callback (10-30s)...");
      
      // Auto-check for decryption completion
      const checkInterval = setInterval(async () => {
        try {
          await loadVotingData();
          const isDecrypted = await votingContract.voteDecrypted(userAddress);
          if (isDecrypted) {
            clearInterval(checkInterval);
            setStatus("‚úÖ Vote decrypted! Now you can claim your reward");
          }
        } catch (e) {
          console.error("Check interval error:", e);
        }
      }, 5000);
      
      setTimeout(() => clearInterval(checkInterval), 120000);
    } catch (err) {
      console.error("‚ùå Decryption request error:", err);
      const errorMessage = err.reason || err.message || '';
      setStatus(`‚ùå Decryption request failed: ${errorMessage}`);
    } finally {
      setVotingLoading(false);
    }
  };

  // Claim reward - only works after vote is decrypted
  const handleClaimReward = async () => {
    try {
      setVotingLoading(true);

      if (!selectedVoting) throw new Error("No voting selected");
      
      const provider = new ethers.BrowserProvider(window.ethereum);
      const signer = await provider.getSigner();
      const votingContract = new ethers.Contract(
        selectedVoting,
        PrivateVotingABI.abi,
        signer
      );

      // Check if vote is already decrypted
      const voteDecrypted = await votingContract.voteDecrypted(userAddress);
      
      if (!voteDecrypted) {
        setStatus("‚ö†Ô∏è Please request decryption first!");
        setVotingLoading(false);
        return;
      }

      setStatus("üí∞ Claiming your reward...");
      const tx = await votingContract.claimReward();
      setStatus(`‚è≥ Confirming transaction: ${tx.hash}`);
      await tx.wait();

      setStatus("‚úÖ Reward claimed successfully!");
      await loadVotingData();
    } catch (err) {
      console.error("‚ùå Claim Error:", err);
      const errorMessage = err.reason || err.message || (err.revert && err.revert.args && err.revert.args[0]) || '';
      setStatus(`‚ùå Claim failed: ${errorMessage || 'Unknown error'}`);
    } finally {
      setVotingLoading(false);
    }
  };

  // Load votings list on tab change
  useEffect(() => {
    if (userAddress && activeTab === "votings") {
      loadAllVotings();
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [userAddress, activeTab]);

  // Load voting data when a voting is selected
  useEffect(() => {
    if (selectedVoting && userAddress && instance) {
      loadVotingData();
      const interval = setInterval(() => loadVotingData(), 30000);
      return () => clearInterval(interval);
    }
    // eslint-disable-next-line react-hooks/exhaustive-deps
  }, [selectedVoting, userAddress, instance]);

  // Helper functions
  const getOptionInfo = (option) => {
    const options = {
      0: { emoji: "üéØ", label: "Option A", price: "$4,000", desc: "Moderate Growth" },
      1: { emoji: "üöÄ", label: "Option B", price: "$10,000", desc: "Moon Shot" },
      2: { emoji: "üìâ", label: "Option C", price: "$2,000", desc: "Bear Market" }
    };
    return options[option];
  };

  const getRankInfo = (option) => {
    if (!votingData) return null;
    if (option === votingData.minorityOption) return { label: "Winner (Minority)", color: "text-green-600", bgColor: "bg-green-500/10", emoji: "üèÜ" };
    if (option === votingData.middleOption) return { label: "Middle", color: "text-yellow-600", bgColor: "bg-yellow-500/10", emoji: "ü•à" };
    if (option === votingData.majorityOption) return { label: "Majority (Lost)", color: "text-red-600", bgColor: "bg-red-500/10", emoji: "‚ùå" };
    return null;
  };

  // === UI ===
  return (
    <div className="min-h-screen bg-gradient-to-br from-background via-background to-muted/20">
      <div className="container mx-auto px-4 py-8">
        {/* Header */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6 }}
          className="text-center mb-8"
        >
          <div className="flex items-center justify-center gap-3 mb-4">
            <Vote className="h-10 w-10 text-purple-600" />
            <h1 className="text-4xl font-bold bg-clip-text text-transparent bg-gradient-to-r from-purple-600 to-pink-600">
              Zama Private Voting
            </h1>
          </div>
          <p className="text-xl font-semibold text-muted-foreground max-w-2xl mx-auto">
            Create and participate in fully encrypted voting rounds
          </p>
        </motion.div>

        {/* Status Bar */}
        <motion.div
          initial={{ opacity: 0, y: 20 }}
          animate={{ opacity: 1, y: 0 }}
          transition={{ duration: 0.6, delay: 0.1 }}
          className="max-w-6xl mx-auto mb-8"
        >
          <Card className="border-2">
            <CardContent className="pt-6">
              <div className="flex items-center gap-3">
                <div className={`h-3 w-3 rounded-full ${instance ? 'bg-green-500 animate-pulse' : 'bg-yellow-500'}`} />
                <p className="text-sm font-medium">{status}</p>
              </div>
            </CardContent>
          </Card>
        </motion.div>

        {instance ? (
          <div className="max-w-6xl mx-auto">
            <Tabs value={activeTab} onValueChange={setActiveTab} className="w-full">
              <TabsList className="grid w-full grid-cols-2 mb-8">
                <TabsTrigger value="votings" className="text-lg">
                  <List className="mr-2 h-5 w-5" />
                  View Votings
                </TabsTrigger>
                <TabsTrigger value="create" className="text-lg">
                  <Plus className="mr-2 h-5 w-5" />
                  Create Voting
                </TabsTrigger>
              </TabsList>

              {/* TAB 1: View Votings */}
              <TabsContent value="votings" className="space-y-6">
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.4 }}
                >
                  {/* Votings Filter */}
                  <Card className="border-2 mb-6">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <List className="h-5 w-5" />
                        All Votings
                      </CardTitle>
                      <CardDescription>
                        Browse and participate in voting rounds
                      </CardDescription>
                    </CardHeader>
                    <CardContent>
                      <Button 
                        onClick={loadAllVotings} 
                        disabled={listLoading}
                        className="w-full md:w-auto"
                      >
                        {listLoading ? "Loading..." : "Refresh Votings"}
                      </Button>
                    </CardContent>
                  </Card>

                  {/* Ongoing Votings */}
                  {ongoingVotings.length > 0 && (
                    <Card className="border-2 border-green-500">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-green-600">
                          <CheckCircle className="h-5 w-5" />
                          Active Votings ({ongoingVotings.length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="grid gap-4">
                          {ongoingVotings.map((voting) => (
                            <Card 
                              key={voting.address} 
                              className="border cursor-pointer hover:border-green-500 transition-colors"
                              onClick={() => {
                                setSelectedVoting(voting.address);
                                setActiveTab("vote");
                              }}
                            >
                              <CardContent className="pt-6">
                                <div className="flex items-start justify-between">
                                  <div>
                                    <h3 className="font-bold text-lg">{voting.name}</h3>
                                    <p className="text-sm text-muted-foreground mt-1">
                                      Deposit: {voting.depositAmount} USDC
                                    </p>
                                    <p className="text-xs text-muted-foreground">
                                      Ends: {new Date(voting.endTime * 1000).toLocaleString()}
                                    </p>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <span className="px-3 py-1 bg-green-500/20 text-green-600 rounded-full text-sm font-semibold">
                                      Active
                                    </span>
                                  </div>
                                </div>
                              </CardContent>
                            </Card>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Upcoming Votings */}
                  {upcomingVotings.length > 0 && (
                    <Card className="border-2 border-blue-500">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2 text-blue-600">
                          <Calendar className="h-5 w-5" />
                          Upcoming Votings ({upcomingVotings.length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="grid gap-4">
                          {upcomingVotings.map((voting) => (
                            <Card key={voting.address} className="border">
                              <CardContent className="pt-6">
                                <div className="flex items-start justify-between">
                                  <div>
                                    <h3 className="font-bold text-lg">{voting.name}</h3>
                                    <p className="text-sm text-muted-foreground mt-1">
                                      Deposit: {voting.depositAmount} USDC
                                    </p>
                                    <p className="text-xs text-muted-foreground">
                                      Starts: {new Date(voting.startTime * 1000).toLocaleString()}
                                    </p>
                                  </div>
                                  <span className="px-3 py-1 bg-blue-500/20 text-blue-600 rounded-full text-sm font-semibold">
                                    Upcoming
                                  </span>
                                </div>
                              </CardContent>
                            </Card>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {/* Ended Votings */}
                  {endedVotings.length > 0 && (
                    <Card className="border-2">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <XCircle className="h-5 w-5" />
                          Past Votings ({endedVotings.length})
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="grid gap-4">
                          {endedVotings.map((voting) => (
                            <Card 
                              key={voting.address} 
                              className="border cursor-pointer hover:border-purple-500 transition-colors opacity-75"
                              onClick={() => {
                                setSelectedVoting(voting.address);
                                setActiveTab("vote");
                              }}
                            >
                              <CardContent className="pt-6">
                                <div className="flex items-start justify-between">
                                  <div>
                                    <h3 className="font-bold text-lg">{voting.name}</h3>
                                    <p className="text-sm text-muted-foreground mt-1">
                                      Deposit: {voting.depositAmount} USDC
                                    </p>
                                    <p className="text-xs text-muted-foreground">
                                      Ended: {new Date(voting.endTime * 1000).toLocaleString()}
                                    </p>
                                  </div>
                                  <div className="flex items-center gap-2">
                                    <span className="px-3 py-1 bg-gray-500/20 text-gray-600 rounded-full text-sm font-semibold">
                                      Ended
                                    </span>
                                    {voting.resolved && voting.revealed && (
                                      <span className="px-3 py-1 bg-purple-500/20 text-purple-600 rounded-full text-sm font-semibold">
                                        Results
                                      </span>
                                    )}
                                  </div>
                                </div>
                              </CardContent>
                            </Card>
                          ))}
                        </div>
                      </CardContent>
                    </Card>
                  )}

                  {!listLoading && ongoingVotings.length === 0 && upcomingVotings.length === 0 && endedVotings.length === 0 && (
                    <Card className="border-2">
                      <CardContent className="pt-12 pb-12 text-center">
                        <p className="text-muted-foreground">No votings found. Create one to get started!</p>
                      </CardContent>
                    </Card>
                  )}
                </motion.div>
              </TabsContent>

              {/* TAB 2: Create Voting */}
              <TabsContent value="create" className="space-y-6">
                <motion.div
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  transition={{ duration: 0.4 }}
                >
                  <Card className="border-2">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <Plus className="h-5 w-5" />
                        Create New Voting Round
                      </CardTitle>
                      <CardDescription>
                        Set up a new private voting session with custom parameters
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-6">
                      <div className="space-y-2">
                        <Label htmlFor="name">Voting Name</Label>
                        <Input
                          id="name"
                          placeholder="e.g., ETH Price Prediction 2026"
                          value={votingName}
                          onChange={(e) => setVotingName(e.target.value)}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="deposit">Vote Deposit Amount (USDC)</Label>
                        <Input
                          id="deposit"
                          type="number"
                          step="0.01"
                          placeholder="10"
                          value={voteDeposit}
                          onChange={(e) => setVoteDeposit(e.target.value)}
                        />
                        <p className="text-xs text-muted-foreground">
                          Amount each participant must deposit to vote
                        </p>
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="startTime">Start Time</Label>
                        <Input
                          id="startTime"
                          type="datetime-local"
                          value={votingStartTime}
                          onChange={(e) => setVotingStartTime(e.target.value)}
                          min={new Date().toISOString().slice(0, 16)}
                        />
                      </div>

                      <div className="space-y-2">
                        <Label htmlFor="duration">Voting Duration (seconds)</Label>
                        <Input
                          id="duration"
                          type="number"
                          placeholder="3600"
                          value={votingDuration}
                          onChange={(e) => setVotingDuration(e.target.value)}
                        />
                        <p className="text-xs text-muted-foreground">
                          3600 = 1 hour, 86400 = 1 day, 604800 = 1 week
                        </p>
                      </div>

                      <Button
                        onClick={handleCreateVoting}
                        disabled={createLoading || !votingName || !votingStartTime}
                        size="lg"
                        className="w-full bg-gradient-to-r from-purple-600 to-pink-600"
                      >
                        {createLoading ? (
                          <>
                            <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
                            Creating...
                          </>
                        ) : (
                          <>
                            <Sparkles className="mr-2 h-4 w-4" />
                            Create Voting Round
                          </>
                        )}
                      </Button>
                    </CardContent>
                  </Card>

                  {/* Info Card */}
                  <Card className="border-2">
                    <CardHeader>
                      <CardTitle className="text-sm">‚ÑπÔ∏è How It Works</CardTitle>
                    </CardHeader>
                    <CardContent className="text-sm text-muted-foreground space-y-2">
                      <p>‚Ä¢ Participants vote by depositing USDC and selecting an encrypted option</p>
                      <p>‚Ä¢ After voting ends, results are revealed through FHE decryption</p>
                      <p>‚Ä¢ Rewards are distributed based on voting patterns (minority wins!)</p>
                      <p>‚Ä¢ All votes remain encrypted until the round ends</p>
                    </CardContent>
                  </Card>
                </motion.div>
              </TabsContent>
            </Tabs>
          </div>
        ) : (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.6 }}
            className="max-w-md mx-auto"
          >
            <Card className="border-2">
              <CardContent className="pt-6 text-center">
                <div className="h-12 w-12 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-4" />
                <p className="text-muted-foreground">Initializing secure connection...</p>
              </CardContent>
            </Card>
          </motion.div>
        )}
      </div>
    </div>
  );
}
                  key="voting-phase"
                  initial={{ opacity: 0, y: 20 }}
                  animate={{ opacity: 1, y: 0 }}
                  exit={{ opacity: 0, y: -20 }}
                  transition={{ duration: 0.6 }}
                  className="space-y-6"
                >
                  {/* Stats */}
                  <div className="grid gap-4 md:grid-cols-3">
                    <Card className="border-2">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                          <TrendingUp className="h-4 w-4" />
                          Total Pool
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="text-2xl font-bold text-purple-600">
                          {votingData.totalVotingUSDC} USDC
                        </div>
                      </CardContent>
                    </Card>
                    <Card className="border-2">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                          <Clock className="h-4 w-4" />
                          Time Remaining
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="text-2xl font-bold text-blue-600">
                          {Math.floor(votingData.timeRemaining / 3600)}h {Math.floor((votingData.timeRemaining % 3600) / 60)}m
                        </div>
                      </CardContent>
                    </Card>
                    <Card className="border-2">
                      <CardHeader className="pb-3">
                        <CardTitle className="text-sm font-medium flex items-center gap-2">
                          <Shield className="h-4 w-4" />
                          Status
                        </CardTitle>
                      </CardHeader>
                      <CardContent>
                        <div className="text-2xl font-bold text-orange-600">
                          üîí Active
                        </div>
                      </CardContent>
                    </Card>
                  </div>

                  {/* Voting UI */}
                  {!votingData.hasVoted ? (
                    <Card className="border-2">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Vote className="h-5 w-5" />
                          Cast Your Vote (10 USDC)
                        </CardTitle>
                        <CardDescription>
                          Select your prediction and deposit 10 USDC. Your vote is fully encrypted!
                        </CardDescription>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        <div className="grid gap-4 md:grid-cols-3">
                          {[0, 1, 2].map((option) => {
                            const info = getOptionInfo(option);
                            return (
                              <Card
                                key={option}
                                className={`border-2 cursor-pointer transition-all hover:scale-105 ${
                                  selectedOption === option
                                    ? "border-purple-600 bg-purple-500/10 shadow-lg"
                                    : "border-muted hover:border-purple-400"
                                }`}
                                onClick={() => setSelectedOption(option)}
                              >
                                <CardContent className="pt-6 text-center">
                                  <div className="text-4xl mb-2">{info.emoji}</div>
                                  <div className="text-xl font-bold mb-1">{info.label}</div>
                                  <div className="text-2xl font-bold text-purple-600 mb-1">{info.price}</div>
                                  <div className="text-sm text-muted-foreground">{info.desc}</div>
                                </CardContent>
                              </Card>
                            );
                          })}
                        </div>

                        <Button
                          onClick={handleVote}
                          disabled={selectedOption === null || votingLoading}
                          size="lg"
                          className="w-full bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700"
                        >
                          {votingLoading ? (
                            <>
                              <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
                              Processing...
                            </>
                          ) : (
                            <>
                              <Vote className="mr-2 h-4 w-4" />
                              Submit Encrypted Vote & Deposit 10 USDC
                            </>
                          )}
                        </Button>
                      </CardContent>
                    </Card>
                  ) : (
                    <div className="space-y-6">
                      <Card className="border-2 border-green-500 bg-green-500/10">
                        <CardContent className="pt-6 text-center py-12">
                          <div className="text-6xl mb-4">‚úÖ</div>
                          <h3 className="text-2xl font-bold mb-2">Vote Submitted!</h3>
                          <p className="text-muted-foreground">
                            Your vote is encrypted and will be revealed when voting ends
                          </p>
                          <div className="mt-4 text-sm text-muted-foreground">
                            ‚è∞ Voting ends in {Math.floor(votingData.timeRemaining / 3600)}h {Math.floor((votingData.timeRemaining % 3600) / 60)}m
                          </div>
                        </CardContent>
                      </Card>

                      {/* Show user's encrypted vote */}
                      <Card className="border-2 bg-gradient-to-br from-purple-500/10 to-pink-600/5">
                        <CardHeader>
                          <CardTitle className="flex items-center gap-2">
                            <Shield className="h-5 w-5 text-purple-600" />
                            Your Encrypted Vote
                          </CardTitle>
                          <CardDescription>
                            Your vote is secured by FHE encryption. It will be revealed after voting ends.
                          </CardDescription>
                        </CardHeader>
                        <CardContent>
                          <div className="p-6 bg-muted/50 rounded-lg text-center space-y-4">
                            <div className="text-5xl">üîê</div>
                            <div>
                              <div className="text-lg font-bold mb-2">Vote Status: Encrypted</div>
                              <div className="text-sm text-muted-foreground">
                                Your selection has been recorded on-chain with full privacy protection
                              </div>
                            </div>
                            <div className="pt-4 border-t space-y-2">
                              <div className="flex items-center justify-between text-sm">
                                <span className="text-muted-foreground">Deposit:</span>
                                <span className="font-bold">10 USDC</span>
                              </div>
                              <div className="flex items-center justify-between text-sm">
                                <span className="text-muted-foreground">Status:</span>
                                <span className="font-bold text-green-600">Confirmed</span>
                              </div>
                              <div className="flex items-center justify-between text-sm">
                                <span className="text-muted-foreground">Reveal Time:</span>
                                <span className="font-bold">{Math.floor(votingData.timeRemaining / 3600)}h {Math.floor((votingData.timeRemaining % 3600) / 60)}m</span>
                              </div>
                            </div>
                          </div>
                        </CardContent>
                      </Card>

                      {/* Voting Instructions */}
                      <Card className="border-2">
                        <CardHeader>
                          <CardTitle className="text-sm font-medium">What Happens Next?</CardTitle>
                        </CardHeader>
                        <CardContent className="text-sm text-muted-foreground space-y-2">
                          <div className="flex items-start gap-2">
                            <span className="text-lg">‚è≥</span>
                            <div>
                              <strong className="text-foreground">Wait for voting to end</strong>
                              <p>The voting period will close automatically after the timer expires</p>
                            </div>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-lg">üîì</span>
                            <div>
                              <strong className="text-foreground">Votes are revealed</strong>
                              <p>All votes will be decrypted and the results will be published on-chain</p>
                            </div>
                          </div>
                          <div className="flex items-start gap-2">
                            <span className="text-lg">üéÅ</span>
                            <div>
                              <strong className="text-foreground">Claim your reward</strong>
                              <p>Come back to this page to see if you won and claim your USDC reward</p>
                            </div>
                          </div>
                        </CardContent>
                      </Card>
                    </div>
                  )}
                </motion.div>
              )}

              {/* PHASE 2: Results Revealed */}
              {votingData && votingData.resultsRevealed && votingData.votingResolved && (
                <motion.div
                  key="results-phase"
                  initial={{ opacity: 0, scale: 0.95 }}
                  animate={{ opacity: 1, scale: 1 }}
                  transition={{ duration: 0.6 }}
                  className="space-y-6"
                >
                  {/* Results Header */}
                  <Card className="border-2 bg-gradient-to-br from-yellow-500/10 to-orange-600/5">
                    <CardContent className="pt-6 text-center">
                      <div className="text-6xl mb-4">üéâ</div>
                      <h2 className="text-3xl font-bold mb-2">Voting Has Ended!</h2>
                      <p className="text-muted-foreground">
                        Results are now public. Check if you won!
                      </p>
                    </CardContent>
                  </Card>

                  {/* Vote Results */}
                  <Card className="border-2">
                    <CardHeader>
                      <CardTitle className="flex items-center gap-2">
                        <Trophy className="h-5 w-5 text-yellow-600" />
                        Final Results
                      </CardTitle>
                      <CardDescription>
                        Total Pool: {votingData.totalVotingUSDC} USDC
                      </CardDescription>
                    </CardHeader>
                    <CardContent className="space-y-3">
                      {[0, 1, 2].map((option) => {
                        const info = getOptionInfo(option);
                        const rank = getRankInfo(option);
                        const votes = option === 0 ? votingData.votesA : option === 1 ? votingData.votesB : votingData.votesC;
                        
                        return (
                          <div
                            key={option}
                            className={`flex items-center justify-between p-4 rounded-lg border-2 ${rank?.bgColor || 'bg-muted/50'}`}
                          >
                            <div className="flex items-center gap-4">
                              <div className="text-4xl">{info.emoji}</div>
                              <div>
                                <div className="font-semibold text-lg">
                                  {info.label}: {info.price}
                                </div>
                                <div className="text-sm text-muted-foreground">{info.desc}</div>
                                {rank && (
                                  <div className={`text-sm font-bold ${rank.color} flex items-center gap-1 mt-1`}>
                                    <span>{rank.emoji}</span>
                                    <span>{rank.label}</span>
                                  </div>
                                )}
                              </div>
                            </div>
                            <div className="text-right">
                              <div className="text-3xl font-bold text-purple-600">
                                {votes}
                              </div>
                              <div className="text-sm text-muted-foreground">votes</div>
                            </div>
                          </div>
                        );
                      })}
                    </CardContent>
                  </Card>

                  {/* Your Vote & Claim */}
                  {votingData.hasVoted && (
                    <Card className="border-2 bg-gradient-to-br from-purple-500/10 to-pink-600/5">
                      <CardHeader>
                        <CardTitle className="flex items-center gap-2">
                          <Award className="h-5 w-5 text-purple-600" />
                          Your Participation
                        </CardTitle>
                      </CardHeader>
                      <CardContent className="space-y-4">
                        {votingData.voteDecrypted && votingData.userDecryptedVote !== undefined && (
                          <div className="p-4 bg-muted/50 rounded-lg space-y-3">
                            <div className="text-sm text-muted-foreground">Your Vote:</div>
                            <div className="flex items-center gap-3">
                              <span className="text-3xl">{getOptionInfo(votingData.userDecryptedVote).emoji}</span>
                              <div>
                                <div className="font-bold text-lg">
                                  {getOptionInfo(votingData.userDecryptedVote).label} - {getOptionInfo(votingData.userDecryptedVote).price}
                                </div>
                                {getRankInfo(votingData.userDecryptedVote) && (
                                  <div className={`text-sm font-bold ${getRankInfo(votingData.userDecryptedVote).color}`}>
                                    {getRankInfo(votingData.userDecryptedVote).emoji} {getRankInfo(votingData.userDecryptedVote).label}
                                  </div>
                                )}
                              </div>
                            </div>
                            
                            {/* Reward Status */}
                            {votingData.userRewardAmount !== undefined && (
                              <div className="pt-3 border-t">
                                <div className="flex items-center justify-between">
                                  <span className="text-sm text-muted-foreground">Your Reward:</span>
                                  <div className="text-right">
                                    {votingData.userRewardAmount === 0 ? (
                                      <div className="text-lg font-bold text-red-600">0 USDC üíî</div>
                                    ) : votingData.userRewardAmount === 9.8 ? (
                                      <div className="text-lg font-bold text-yellow-600">{votingData.userRewardAmount.toFixed(1)} USDC üîÑ</div>
                                    ) : (
                                      <div className="text-lg font-bold text-green-600">{votingData.userRewardAmount.toFixed(1)} USDC üéâ</div>
                                    )}
                                    <div className="text-xs text-muted-foreground">
                                      {votingData.userRewardAmount === 0 && "Lost"}
                                      {votingData.userRewardAmount === 9.8 && "Refunded"}
                                      {votingData.userRewardAmount > 9.8 && `Won ${((votingData.userRewardAmount / 9.8) * 100).toFixed(0)}%!`}
                                    </div>
                                  </div>
                                </div>
                              </div>
                            )}
                          </div>
                        )}

                        {!votingData.hasClaimedReward ? (
                          <>
                            {votingData.userRewardAmount === 0 ? (
                              // No reward - show message instead of claim button
                              <Card className="border-2 border-red-500 bg-red-500/10">
                                <CardContent className="pt-6 text-center">
                                  <div className="text-5xl mb-3">üò¢</div>
                                  <p className="text-lg font-semibold text-red-600">
                                    No Reward Available
                                  </p>
                                  <p className="text-sm text-muted-foreground mt-2">
                                    You voted with the majority and lost your deposit. Better luck next time!
                                  </p>
                                </CardContent>
                              </Card>
                            ) : (
                              <div className="space-y-3">
                                {!votingData.voteDecrypted ? (
                                  <Button
                                    onClick={handleRequestDecryption}
                                    disabled={votingLoading}
                                    size="lg"
                                    className="w-full bg-gradient-to-r from-blue-600 to-purple-600 hover:from-blue-700 hover:to-purple-700"
                                  >
                                    {votingLoading ? (
                                      <>
                                        <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
                                        Processing...
                                      </>
                                    ) : (
                                      <>
                                        <Shield className="mr-2 h-4 w-4" />
                                        Step 1: Request Vote Decryption
                                      </>
                                    )}
                                  </Button>
                                ) : (
                                  <Button
                                    onClick={handleClaimReward}
                                    disabled={votingLoading}
                                    size="lg"
                                    className="w-full bg-gradient-to-r from-yellow-600 to-orange-600 hover:from-yellow-700 hover:to-orange-700"
                                  >
                                    {votingLoading ? (
                                      <>
                                        <div className="mr-2 h-4 w-4 animate-spin rounded-full border-2 border-current border-t-transparent" />
                                        Processing...
                                      </>
                                    ) : (
                                      <>
                                        <Trophy className="mr-2 h-4 w-4" />
                                        {votingData.userRewardAmount === 9.8 
                                          ? 'Step 2: Claim Refund (9.8 USDC)' 
                                          : `Step 2: Claim Reward (${votingData.userRewardAmount?.toFixed(1)} USDC)`
                                        }
                                      </>
                                    )}
                                  </Button>
                                )}
                              </div>
                            )}
                          </>
                        ) : (
                          <Card className="border-2 border-green-500 bg-green-500/10">
                            <CardContent className="pt-6 text-center">
                              <div className="text-5xl mb-3">‚úÖ</div>
                              <p className="text-lg font-semibold text-green-600">
                                Reward Claimed!
                              </p>
                              <p className="text-sm text-muted-foreground mt-2">
                                Thank you for participating!
                              </p>
                            </CardContent>
                          </Card>
                        )}
                      </CardContent>
                    </Card>
                  )}

                  {/* Game Rules Reminder */}
                  <Card className="border-2">
                    <CardHeader>
                      <CardTitle className="text-sm font-medium">Game Rules</CardTitle>
                    </CardHeader>
                    <CardContent className="text-sm text-muted-foreground space-y-2">
                      <div>üèÜ <strong>Minority (Fewest votes):</strong> Wins 2x their deposit</div>
                      <div>ü•à <strong>Middle:</strong> Gets their deposit back (1x)</div>
                      <div>‚ùå <strong>Majority (Most votes):</strong> Loses their deposit (0x)</div>
                      <div className="pt-2 border-t">
                        üí° <strong>Strategy:</strong> Pick the option you think OTHERS wont pick!
                      </div>
                    </CardContent>
                  </Card>
                </motion.div>
              )}
            </AnimatePresence>
          </div>
        ) : (
          <motion.div
            initial={{ opacity: 0, scale: 0.95 }}
            animate={{ opacity: 1, scale: 1 }}
            transition={{ duration: 0.6 }}
            className="max-w-md mx-auto"
          >
            <Card className="border-2">
              <CardContent className="pt-6 text-center">
                <div className="h-12 w-12 animate-spin rounded-full border-4 border-primary border-t-transparent mx-auto mb-4" />
                <p className="text-muted-foreground">Initializing secure connection...</p>
              </CardContent>
            </Card>
          </motion.div>
        )}
      </div>
    </div>
  );
}
